/*
  iSYS4001 Radar Sensor - Simple & Efficient Example
  --------------------------------------------------
  ESP32 interface with iSYS4001 radar sensor
  
  Features:
  - Configure output filter (MAX) and signal filter (velocity)
  - Real-time target detection with debug output
  - Efficient retry logic and error handling
  
  Wiring: Radar TX→GPIO16, Radar RX→GPIO17, GND shared
*/

#include "iSYS4001.h"

// Configuration
iSYS4001 radar(Serial2, 115200);
iSYSTargetList_t targetList;
const uint8_t DEVICE_ADDR = 0x80;
const uint32_t TIMEOUT_MS = 300;
const bool DEBUG_ENABLED = true;      // Set to false to disable debug output

void setup() {
  Serial.begin(115200);
  while (!Serial) { delay(10); }
  
  Serial.println("=== iSYS4001 Radar Setup ===");
  
  // Enable debug output
  if (DEBUG_ENABLED) {
    radar.setDebug(Serial, true);
    Serial.println("Debug enabled");
  }
  
  // Initialize radar communication
  Serial2.begin(115200, SERIAL_8N1, 16, 17);
  while (Serial2.available()) { Serial2.read(); } // Flush
  delay(500);
  
  // Configure radar filters
  Serial.println("Configuring radar filters...");
  
  iSYSResult_t res = radar.iSYS_setOutputFilterType(ISYS_OUTPUT_1, ISYS_OUTPUT_FILTER_MAX, DEVICE_ADDR, TIMEOUT_MS);
  if (res == ERR_OK) {
    Serial.println("Output filter: MAX");
  } else {
    Serial.printf("Output filter failed: 0x%02X\n", res);
  }
  
  res = radar.iSYS_setOutputSignalFilter(ISYS_OUTPUT_1, ISYS_VELOCITY_RADIAL, DEVICE_ADDR, TIMEOUT_MS);
  if (res == ERR_OK) {
    Serial.println("Signal filter: VELOCITY_RADIAL");
  } else {
    Serial.printf("Signal filter failed: 0x%02X\n", res);
  }
  
  // Save settings
  res = radar.saveAllSettings(DEVICE_ADDR, TIMEOUT_MS);
  if (res == ERR_OK) {
    Serial.println("Settings saved");
  } else {
    Serial.printf("Save failed: 0x%02X\n", res);
  }
  
  Serial.println("=== Ready - Starting Detection ===\n");
}

void loop() {
  // Clear stale data
  while (Serial2.available()) { Serial2.read(); }

  // Request target list with retry
  iSYSResult_t res = radar.getTargetList32(&targetList, DEVICE_ADDR, TIMEOUT_MS);
  if (res != ERR_OK) {
    res = radar.getTargetList32(&targetList, DEVICE_ADDR, TIMEOUT_MS); // Retry once
  }

  // Display results
  if (res == ERR_OK && targetList.error.iSYSTargetListError == TARGET_LIST_OK) {
    Serial.printf("%u targets detected\n", targetList.nrOfTargets);
    
    if (targetList.nrOfTargets > 0) {
      for (uint16_t i = 0; i < targetList.nrOfTargets && i < MAX_TARGETS; i++) {
        Serial.printf("  T%u: Sig=%.1fdB Vel=%.2fm/s Range=%.2fm Ang=%.1f°\n",
                     i + 1,
                     targetList.targets[i].signal,
                     targetList.targets[i].velocity,
                     targetList.targets[i].range,
                     targetList.targets[i].angle);
      }
    } else {
      Serial.println("No targets in range");
    }
  } else {
    Serial.printf("Detection failed (0x%02X)\n", res);
  }

  delay(500); // 500ms between readings
}

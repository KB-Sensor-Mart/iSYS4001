/*
  iSYS4001 Radar Sensor (Get Target List)
  --------------------------------------
  Minimal example to request and print the target list using an ESP32.

  Wiring (ESP32):
    - RX (GPIO16) ←→ Radar TX
    - TX (GPIO17) ←→ Radar RX
    - GND shared

  Notes:
    - Adjust DESTINATION_ADDRESS if your sensor uses a different address.
    - Use getTargetList32 for higher precision (default here).
*/

#include "iSYS4001.h"

// Radar object and configuration
iSYS4001 radar(Serial2, 115200);
constexpr uint8_t DESTINATION_ADDRESS = 0x80;
constexpr uint32_t TIMEOUT_MS = 300; // ms
static iSYSTargetList_t targetList;

// ---------------------- Helper Functions ---------------------- //
void flushSerial2() {
  while (Serial2.available()) { Serial2.read(); }
}

bool requestTargetList() {
  iSYSResult_t res = radar.getTargetList32(&targetList, DESTINATION_ADDRESS, TIMEOUT_MS);
  if (res != ERR_OK) {
    // one quick retry
    res = radar.getTargetList32(&targetList, DESTINATION_ADDRESS, TIMEOUT_MS);
  }
  return (res == ERR_OK) && (targetList.error.iSYSTargetListError == TARGET_LIST_OK);
}

// ---------------------- Arduino Setup & Loop ---------------------- //
void setup() {
  Serial.begin(115200);
  while (!Serial) { delay(10); }

  // Enable debug output from the iSYS4001 library to USB Serial
  radar.setDebug(Serial, true);

  // Initialize Serial2 for radar
  Serial2.begin(115200, SERIAL_8N1, 16, 17);

  flushSerial2();
  delay(100);
}

void loop() {
  flushSerial2();
  if (requestTargetList()) {
    Serial.printf("Targets: %u (Out %u)\n", targetList.nrOfTargets, targetList.outputNumber);
    for (uint16_t i = 0; i < targetList.nrOfTargets && i < MAX_TARGETS; i++) {
      Serial.printf("#%u Signal:%.2f dB Velocity:%.2f m/s Range:%.2f m Angle:%.2f deg\n",
                    i + 1,
                    targetList.targets[i].signal,
                    targetList.targets[i].velocity,
                    targetList.targets[i].range,
                    targetList.targets[i].angle);
    }
  } else {
    Serial.println("getTargetList failed");
  }
  delay(400);
}
